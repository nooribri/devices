<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <title>Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ø§Ù„Ø© Ù„Ù„Ø´Ø·Ø¨</title>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <style>
     body {
      font-family: 'Cairo', sans-serif;
      direction: rtl;
      background-color: #f0f0f0;
      margin: 0;
      padding: 0 10px;
    }
    h2 {
      text-align: center;
      margin-top: 10px;
    }
    form {
      background: #fff;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 10px #ccc;
      max-width: 600px;
      margin: 1px auto;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    input, button {
      padding: 5px;
      font-size: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }

    label { display: block; margin-top: 15px; font-weight: bold; }
    input, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 15px;
      cursor: pointer;
    }

    .add-btn { background-color: #28a745; color: white; }
    .add-btn:hover { background-color: #218838; }
    .edit-btn { background-color: #007bff; color: white; }
    .edit-btn:hover { background-color: #0069d9; }
    .delete-btn { background-color: #dc3545; color: white; }
    .delete-btn:hover { background-color: #c82333; }

    .search-container {
      text-align: center;
      margin: 20px 0;
    }

    .search-container input {
      width: 40%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin: 30px auto;
      background-color: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    th, td {
      border: 1px solid #ddd;
      padding: 12px;
      text-align: center;
    }

    th {
      background-color: #007bff;
      color: white;
    }

    .success {
      color: green;
      text-align: center;
      font-weight: bold;
      margin-top: 10px;
    }

    @media (max-width: 768px) {
      .search-container input {
        width: 80%;
      }
    }
    .small-btn {
      padding: 6px 12px;
      font-size: 14px;
      border-radius: 5px;
      background-color: #13a8c2;
      color: white;
      border: none;
      cursor: pointer;
    }
    .small-btn:hover {
      background-color: #0056b3;
    }
    .export-buttons {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .footer-button {
      text-align: center;
      margin: 25px;
    }
    @media print {
      form, .tools, .export-buttons, .footer-button, .search-container, th:last-child, td:last-child {
        display: none !important;
      }
    }
  </style>
</head>
<body>

  <h2>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ø§Ù„Ø© Ù„Ù„Ø´Ø·Ø¨</h2>

  <form id="old-device">
   
    <label>Ø§Ø³Ù… ØµØ§Ø­Ø¨ Ø§Ù„Ø¹Ù‡Ø¯Ø©</label>
    <input type="text" name="owner" required>

     <label>Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø§Ø²</label>
    <input type="text" name="deviceName" >

    <label>Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø§Ø²</label>
    <input type="text" name="deviceType" >

    <label>Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ Ù„Ù„Ø¬Ù‡Ø§Ø²</label>
    <input type="text" name="serialDevice">

    <label>Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ Ù„Ù„Ø´Ø§Ø´Ø©</label>
    <input type="text" name="serialMonitor">

    <label>Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ Ù„Ù„ÙØ£Ø±Ø©</label>
    <input type="text" name="serialMouse">

    <label>Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­</label>
    <input type="text" name="serialKeyboard">

    <label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
    <textarea name="notes" rows="3"></textarea>

    <div class="buttons">
      <button type="submit" class="add-btn">â• Ø¥Ø¶Ø§ÙØ©</button>
    </div>

    <div id="successMsg" class="success"></div>
  </form>

  <div class="search-container">
    <input type="text" id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ù‡Ù†Ø§" onkeyup="filterTable()" />
  </div>

  <table id="deviceTable">
    <thead>
      <tr>
        <th>Ø§Ø³Ù… ØµØ§Ø­Ø¨ Ø§Ù„Ø¹Ù‡Ø¯Ø©</th>
         <th>Ø§Ø³Ù… Ø§Ù„Ø¬Ù‡Ø§Ø²</th>
        <th>Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù‡Ø§Ø²</th>
        <th>Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ Ù„Ù„Ø¬Ù‡Ø§Ø²</th>
        <th>Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ Ù„Ù„Ø´Ø§Ø´Ø©</th>
        <th>Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ Ù„Ù„ÙØ£Ø±Ø©</th>
        <th>Ø±Ù‚Ù… Ø§Ù„ØªØ³Ù„Ø³Ù„ Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙØ§ØªÙŠØ­</th>
        <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
        <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <div class="export-buttons">
  <button class="small-btn" onclick="exportToExcel()">ØªØµØ¯ÙŠØ± Excel</button>
  <button class="small-btn" onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø©</button>
</div>

<div class="footer-button">
  <button onclick="location.href='index.html'" class="small-btn">â†©ï¸ Ø±Ø¬ÙˆØ¹</button>
</div>


  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzxMhNY5gMb6e5SXDhyiKlwxHVvDfsdLn3SMhSzIMphrgVPnl81ScWbeyu2NPCJkVeE/exec"; // Ø¶Ø¹ Ø±Ø§Ø¨Ø· Web App Ø§Ù„ØµØ­ÙŠØ­ Ù‡Ù†Ø§
    let editRowIndex = null;

    const successMsgEl = document.getElementById("successMsg");
    const addBtn = document.querySelector(".add-btn");
    const form = document.getElementById("old-device");

    form.addEventListener("submit", function(e) {
      e.preventDefault();
      successMsgEl.textContent = "";
      const data = {
        owner: form.owner.value.trim(),
        deviceName: form.deviceName.value.trim(),
        deviceType: form.deviceType.value.trim(),
        serialDevice: form.serialDevice.value.trim(), 
        serialMonitor: form.serialMonitor.value.trim(),
        serialMouse: form.serialMouse.value.trim(),
        serialKeyboard: form.serialKeyboard.value.trim(),
        notes: form.notes.value.trim()
      };

      const method = editRowIndex ? "PUT" : "POST";
      if (editRowIndex) data.rowIndex = editRowIndex;

      fetch(API_URL, {
        method: method,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      })
      .then(async res => {
        const text = await res.text();
        if (!res.ok) throw new Error(text || "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©");
        successMsgEl.textContent = editRowIndex ? "ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­" : "ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­";
        resetForm();
        loadDevices();
      })
      .catch(err => {
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + err.message);
        console.error(err);
      });
    });

    function loadDevices() {
      fetch(API_URL)
        .then(res => res.json())
        .then(data => {
          const tbody = document.querySelector("#deviceTable tbody");
          tbody.innerHTML = "";
          data.forEach(row => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${escapeHtml(row.owner)}</td>
              <td>${escapeHtml(row.deviceName)}</td>
              <td>${escapeHtml(row.deviceType)}</td>
              <td>${escapeHtml(row.serialDevice)}</td> 
              <td>${escapeHtml(row.serialMonitor)}</td>
              <td>${escapeHtml(row.serialMouse)}</td>
              <td>${escapeHtml(row.serialKeyboard)}</td>
              <td>${escapeHtml(row.notes)}</td>
              <td>
                <button class="edit-btn" onclick='editRow(${JSON.stringify(row)})'>âœï¸</button>
                <button class="delete-btn" onclick='deleteRow(${row.rowIndex})'>ğŸ—‘ï¸</button>
              </td>
            `;
            tbody.appendChild(tr);
          });
        })
        .catch(err => {
          alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
          console.error(err);
        });
    }

    function editRow(row) {
      form.owner.value = row.owner;
      form.deviceName.value = row.deviceName;
      form.deviceType.value = row.deviceType;
      form.serialDevice.value = row.serialDevice;
      form.serialMonitor.value = row.serialMonitor;
      form.serialMouse.value = row.serialMouse;
      form.serialKeyboard.value = row.serialKeyboard;
      form.notes.value = row.notes;

      editRowIndex = row.rowIndex;
      addBtn.textContent = "ğŸ’¾ ØªØ¹Ø¯ÙŠÙ„";
      successMsgEl.textContent = "";
    }

    function deleteRow(rowIndex) {
      if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø±ØŸ")) {
        fetch(API_URL, {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ rowIndex })
        })
        .then(res => res.text())
        .then(msg => {
          alert("âœ… ØªÙ… Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­");
          loadDevices();
          if (editRowIndex === rowIndex) resetForm(); // Ø¥Ø°Ø§ Ø­Ø°ÙÙ†Ø§ Ø§Ù„ØµÙ Ø§Ù„Ù…ÙØªÙˆØ­ Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ØŒ Ù†Ø¹ÙŠØ¯ ÙÙˆØ±Ù… Ø¬Ø¯ÙŠØ¯
        })
        .catch(err => {
          alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù");
          console.error(err);
        });
      }
    }

    function resetForm() {
      form.reset();
      editRowIndex = null;
      addBtn.textContent = "â• Ø¥Ø¶Ø§ÙØ©";
      successMsgEl.textContent = "";
    }

    function filterTable() {
      const input = document.getElementById("searchInput").value.toLowerCase();
      const rows = document.querySelectorAll("#deviceTable tbody tr");
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(input) ? "" : "none";
      });
    }

    // Ù„Ù…Ù†Ø¹ Ø­Ù‚Ù† Ø£ÙƒÙˆØ§Ø¯ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ø­Ù…Ø§ÙŠØ© Ø¨Ø³ÙŠØ·Ø©)
    function escapeHtml(text) {
      if (!text) return "";
      return text.replace(/[&<>"']/g, function(m) {
        return {
          '&': "&amp;",
          '<': "&lt;",
          '>': "&gt;",
          '"': "&quot;",
          "'": "&#39;"
        }[m];
      });
    }

  function exportToExcel() {
    const table = document.getElementById("deviceTable");

    // ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    if (!table) {
      alert("âš ï¸ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.");
      return;
    }

    const wb = XLSX.utils.book_new();
    const ws_data = [];

    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø±Ø¤ÙˆØ³ (Ø¨Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø¹Ù…ÙˆØ¯ "Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡")
    const headers = [];
    table.querySelectorAll("thead th").forEach((th, index) => {
      if (th.textContent.trim() !== "Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡") {
        headers.push(th.textContent.trim());
      }
    });
    ws_data.push(headers);

    // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØµÙÙˆÙ
    table.querySelectorAll("tbody tr").forEach(tr => {
      const row = [];
      const tds = tr.querySelectorAll("td");
      for (let i = 0; i < headers.length; i++) {
        row.push(tds[i]?.textContent.trim() || "");
      }
      ws_data.push(row);
    });

    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©");

   // Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù
    XLSX.writeFile(wb, "Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©_Ø§Ù„Ù…Ø­Ø§Ù„Ø© Ù„Ù„Ø´Ø·Ø¨");
  }
</script>

    window.onload = loadDevices;
  </script>
</body>
</html>